#!/bin/bash

# Google Closure Compiler (GCC) Toolkit
# see https://github.com/allex/etc/blob/master/bin/closure

# Author: Allex (allex.wxn@gmail.com)
# Last Modified: Wed Jan 09, 2013 06:18PM

type java >/dev/null 2>&1 || { echo >&2 "Java not installed. Aborting."; exit 1; }

EXEC_DIR=`dirname $(readlink -f $0)`
COMPILER="$EXEC_DIR/lib/compiler.jar"
[ -r "$COMPILER" ] || COMPILER="$LIB/compiler.jar"
GCC="java -Xms64m -Xmx128m -Djava.library.path=$EXEC_DIR/lib -jar $COMPILER"

if [ ! -r $COMPILER ]; then
    echo "Error: Unable to access jarfile compiler.jar"; exit 1;
fi

# for more see http://code.google.com/p/closure-compiler/wiki/Warnings
args="--charset UTF-8 --language_in=ECMASCRIPT5_STRICT"

# --warning_level VERBOSE|DEFAULT|QUIET
warning_level="DEFAULT";

usage() {
    $GCC --help;
}

# do some pre-compile syntax parsing
prebuild() {
    perl -0777 -i -pe 's/<debug>[\s\S]*?<\/debug>//g' $1
}

# create tmp file for dist
tmpfile=$(mktemp);

# parse arguments, normalize params.
while [ $# -gt 0 ]
do
    case $1 in
        -t|--warning_level)
            warning_level=$2;

            case ${warning_level} in
                (QUIET|DEFAULT|VERBOSE)
                    shift;
                    ;;
                (*) warning_level="DEFAULT";
                    if [ "$1" == "-t" ]; then
                        warning_level="VERBOSE";
                    fi
                    ;;
            esac
            ;;

        -h|--help|-\?) usage; exit;;
        (--) shift; break;;

        (*) arg=$1;

            # Handle the un-prefixed arg to filename
            if [ "${arg:0:1}" != "-" ]; then
                filename=${arg};
                if [ -f "$filename" ]; then
                    cp $filename $tmpfile
                    args="${args} --js $tmpfile";
                fi
            else
                args="${args} $arg $2";
                shift;
            fi

            ;;
    esac
    shift
done

args="${args} --warning_level ${warning_level}"

# check input filepath or stdin mode
if [ $(expr "${args}" : ".* --js .*") -eq 0 ]; then
    args="${args} --js $tmpfile";
    tee $tmpfile > /dev/null
fi

# compile target file
prebuild $tmpfile
$GCC ${args}

# remove tmp file
rm $tmpfile;
